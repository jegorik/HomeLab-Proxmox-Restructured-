# =============================================================================
# Vault Application Installation and Configuration Role
# =============================================================================
# This role installs HashiCorp Vault from the official repository and
# configures the necessary system components.
#
# Tasks:
#   1. Install system dependencies
#   2. Add HashiCorp GPG key and repository
#   3. Install Vault package
#   4. Create system user for Vault
#   5. Create data and configuration directories
#   6. Deploy Vault configuration file
#
# Prerequisites:
#   - Debian/Ubuntu system with apt package manager
#   - Internet connectivity
#   - Root or sudo privileges
#
# Variables Required:
#   - vault_keyring_dir: GPG keyring directory
#   - vault_data_dir: Vault data storage path
#   - vault_config_dir: Configuration directory
#   - vault_config_file: Config template name
#   - vault_config_path: Full path to config file
#   - vault_user: System user for Vault
#   - vault_group: System group for Vault
#
# Author: HomeLab Infrastructure Team
# =============================================================================

- name: Install Vault dependencies
  ansible.builtin.apt:
    name:
      - python3 # Python runtime
      - python3-pip # Python package installer
      - python3-venv # Virtual environment support
      - python3-dev # Python development headers
      - wget # File download utility
      - gpg # GNU Privacy Guard for key verification
      - curl # URL transfer utility
      - unzip # Archive extraction
      - lsb-release # Linux Standard Base version info
      - ca-certificates # SSL/TLS certificate authorities
      - sudo # Elevated privilege execution
    state: present
    update_cache: true
    cache_valid_time: 3600
  tags: ["install", "dependencies"]

- name: Create keyring directory
  ansible.builtin.file:
    path: "{{ vault_keyring_dir }}"
    state: directory
    mode: "0755"
  tags: ["install", "directory"]

# Get system architecture securely for repository definition (used in apt_repository)
- name: Get system architecture
  ansible.builtin.command: dpkg --print-architecture
  register: vault_system_architecture
  changed_when: false
  check_mode: false
  tags: ["install", "repository"]

# Download the GPG key to a temporary location
- name: Download HashiCorp GPG key
  ansible.builtin.get_url:
    url: https://apt.releases.hashicorp.com/gpg
    dest: /tmp/hashicorp.gpg.asc
    mode: "0644"
  tags: ["install", "repository"]

# Dearmor the key to the keyring directory
# checking for existence in the `creates` argument ensures idempotency
- name: Dearmor HashiCorp GPG key
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg /tmp/hashicorp.gpg.asc
    creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg
  tags: ["install", "repository"]

# Add the repository using the native apt_repository module
- name: Add HashiCorp repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ vault_system_architecture.stdout }} signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg]
      https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main
    filename: hashicorp
    state: present
  tags: ["install", "repository"]

# Install Vault from HashiCorp's official repository
- name: Install Vault
  ansible.builtin.apt:
    name: vault
    state: present
    update_cache: true
  tags: ["install", "vault"]

# Create dedicated system group for Vault service
- name: Create Vault system group
  ansible.builtin.group:
    name: "{{ vault_group }}"
    gid: 900
    system: true
    state: present
  tags: ["install", "user"]

# Create dedicated system user for Vault service
# - System user (no login shell, no home directory in /home)
# - Home directory: /etc/vault.d (config directory)
# - Shell: /bin/false (no interactive login)
# - Used for running Vault process with limited privileges
- name: Create Vault system user
  ansible.builtin.user:
    name: "{{ vault_user }}"
    group: "{{ vault_group }}"
    uid: 900
    system: true
    home: "{{ vault_config_dir }}"
    shell: /bin/false
    create_home: false
  tags: ["install", "user"]

# Create required directories with proper ownership and permissions
# - vault_data_dir: Stores Vault's encrypted data (755)
# - vault_config_dir: Contains configuration files (750 for security)
- name: Create Vault data and config directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    recurse: true
    mode: "{{ item.mode }}"
  loop:
    - {
      path: "{{ vault_data_dir }}",
      owner: "{{ vault_user }}",
      group: "{{ vault_group }}",
      mode: "0755",
    }
    - {
      path: "{{ vault_config_dir }}",
      owner: "{{ vault_user }}",
      group: "{{ vault_group }}",
      mode: "0750",
    }
  tags: ["install", "user-directories"]

# Deploy Vault configuration from Jinja2 template
# Configuration includes:
#   - UI enabled
#   - File storage backend
#   - TCP listener (HTTP, no TLS - use reverse proxy for production)
#   - disable_mlock=true (required for LXC containers)
- name: Create Vault configuration file
  ansible.builtin.template:
    src: "{{ vault_config_file }}"
    dest: "{{ vault_config_path }}"
    owner: "{{ vault_user }}"
    group: "{{ vault_group }}"
    mode: "0640"
  tags: ["install", "configuration"]
