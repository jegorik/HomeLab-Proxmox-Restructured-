---
# =============================================================================
# Promtail Configuration Template
# =============================================================================
# Configured to push logs to secured Loki instance via HTTPS + Basic Auth
# =============================================================================

server:
  http_listen_port: {{ promtail_http_port }}
  grpc_listen_port: 0

positions:
  filename: {{ promtail_positions_file }}

clients:
  - url: {{ promtail_loki_url }}/loki/api/v1/push
    basic_auth:
      username: {{ promtail_basic_auth_user }}
      password_file: {{ promtail_password_file }}

scrape_configs:
  - job_name: {{ promtail_job_name }}
    static_configs:
      - targets:
          - localhost
        labels:
          job: {{ promtail_job_name }}
          host: {{ ansible_facts['hostname'] }}
          os: {{ ansible_facts['distribution'] }}
          __path__: /placeholder  # replaced by file_sd below

    # Collect all configured log paths
    file_sd_configs: []

  # Separate static config for each log path
  - job_name: {{ promtail_job_name }}_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: {{ promtail_job_name }}
          host: {{ ansible_facts['hostname'] }}
          os: {{ ansible_facts['distribution'] }}
{% for path in promtail_log_paths %}
          __path__: {{ path }}
{% endfor %}
