---
# =============================================================================
# Docker Role - Main Tasks
# =============================================================================
# Installs Docker CE and Docker Compose on Ubuntu Server
#
# Features:
# - Official Docker APT repository setup
# - Docker CE and Docker Compose plugin installation
# - Docker daemon configuration with log rotation
# - User group configuration for docker access
#
# Last Updated: January 2026
# =============================================================================

# -----------------------------------------------------------------------------
# Prerequisites
# -----------------------------------------------------------------------------

- name: Remove old Docker packages if present
  ansible.builtin.apt:
    name:
      - docker
      - docker-engine
      - docker.io
      - containerd
      - runc
    state: absent
  tags: [docker, install]

- name: Install Docker prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  tags: [docker, install]

# -----------------------------------------------------------------------------
# Docker APT Repository Setup
# -----------------------------------------------------------------------------

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  tags: [docker, install]

- name: Add Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
  tags: [docker, install]

- name: Get Ubuntu codename
  ansible.builtin.command: lsb_release -cs
  register: ubuntu_codename
  changed_when: false
  tags: [docker, install]

- name: Get system architecture
  ansible.builtin.command: dpkg --print-architecture
  register: system_arch
  changed_when: false
  tags: [docker, install]

- name: Add Docker APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ubuntu_codename.stdout }} stable"
    state: present
    filename: docker
  tags: [docker, install]

# -----------------------------------------------------------------------------
# Docker Installation
# -----------------------------------------------------------------------------

- name: Install Docker CE and plugins
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes
  tags: [docker, install]

# -----------------------------------------------------------------------------
# Docker Daemon Configuration
# -----------------------------------------------------------------------------

- name: Create Docker config directory
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    mode: '0755'
  tags: [docker, config]

- name: Configure Docker daemon
  ansible.builtin.template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: '0644'
  notify: Restart Docker
  tags: [docker, config]

# -----------------------------------------------------------------------------
# Docker Service
# -----------------------------------------------------------------------------

- name: Enable and start Docker service
  ansible.builtin.systemd:
    name: docker
    enabled: yes
    state: started
  tags: [docker, service]

- name: Enable and start containerd service
  ansible.builtin.systemd:
    name: containerd
    enabled: yes
    state: started
  tags: [docker, service]

# -----------------------------------------------------------------------------
# User Configuration
# -----------------------------------------------------------------------------

- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: yes
  loop: "{{ docker_users }}"
  when: docker_users is defined and docker_users | length > 0
  tags: [docker, users]

# -----------------------------------------------------------------------------
# Verification
# -----------------------------------------------------------------------------

- name: Verify Docker installation
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false
  tags: [docker, verify]

- name: Display Docker version
  ansible.builtin.debug:
    msg: "Docker installed: {{ docker_version.stdout }}"
  tags: [docker, verify]

- name: Verify Docker Compose installation
  ansible.builtin.command: docker compose version
  register: compose_version
  changed_when: false
  tags: [docker, verify]

- name: Display Docker Compose version
  ansible.builtin.debug:
    msg: "Docker Compose installed: {{ compose_version.stdout }}"
  tags: [docker, verify]
