---
- name: Ensure system is updated
  community.general.zypper:
    name: "*"
    state: latest
    update_cache: true
  register: common_zypper_update
  retries: 3
  delay: 10

- name: Install base packages
  community.general.zypper:
    name:
      - vim
      - sudo
      - curl
      - wget
      - git
      - firewalld
      - man
    state: present

- name: Install additional utility packages
  community.general.zypper:
    name: "{{ common_packages }}"
    state: present

- name: Set system timezone
  community.general.timezone:
    name: "{{ common_timezone }}"

- name: Ensure firewalld is running and enabled
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true
  when: common_firewall_enabled

- name: Configure Firewall - Allow services
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop: "{{ common_firewall_allowed_services }}"
  when: common_firewall_enabled
  notify: Reload firewalld

- name: Ensure sudo package is installed
  community.general.zypper:
    name: sudo
    state: present

- name: Check if sudoers file exists
  ansible.builtin.stat:
    path: /etc/sudoers
  register: common_sudoers_stat

- name: Create sudoers file if missing (OpenSUSE minimal)
  ansible.builtin.copy:
    content: |
      ## sudoers file
      ## This file MUST be edited with the 'visudo' command.

      Defaults env_reset
      Defaults mail_badpass
      Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

      root ALL=(ALL:ALL) ALL
      %wheel ALL=(ALL:ALL) NOPASSWD: ALL
    dest: /etc/sudoers
    owner: root
    group: root
    mode: "0440"
    validate: "visudo -cf %s"
  when: not common_sudoers_stat.stat.exists

- name: Ensure passwordless sudo for wheel group
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    regexp: "^%wheel"
    line: "%wheel ALL=(ALL:ALL) NOPASSWD: ALL"
    validate: "visudo -cf %s"
  when: common_sudoers_stat.stat.exists
