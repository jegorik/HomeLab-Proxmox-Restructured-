---
# =============================================================================
# PostgreSQL Installation and Configuration Role
# =============================================================================
# Installs PostgreSQL 17 from Debian 13 repositories and configures database
# for NetBox application with secure credentials from Vault
# =============================================================================

- name: Install PostgreSQL server and client
  ansible.builtin.apt:
    name:
      - postgresql-{{ postgres_version }}
      - postgresql-client-{{ postgres_version }}
      - python3-psycopg2  # Required for Ansible PostgreSQL modules
    state: present
    update_cache: true
  tags: ['install']

- name: Ensure PostgreSQL service is running and enabled
  ansible.builtin.systemd:
    name: postgresql
    state: started
    enabled: true
  tags: ['service']

- name: Check if database credentials exist in Vault
  ansible.builtin.uri:
    url: "{{ vault_addr }}/v1/{{ vault_kv_path }}"
    method: GET
    headers:
      X-Vault-Token: "{{ lookup('env', 'VAULT_TOKEN') }}"
    return_content: true
    status_code: [200, 404]
  register: vault_check
  no_log: true
  tags: ['vault', 'secrets']

- name: Retrieve NetBox database password from Vault if it exists
  ansible.builtin.set_fact:
    netbox_db_password: "{{ vault_check.json.data.data.db_password }}"
  no_log: true
  when:
    - vault_check.status == 200
    - vault_check.json is defined
    - vault_check.json.data is defined
    - vault_check.json.data.data is defined
    - vault_check.json.data.data.db_password is defined
  tags: ['vault', 'secrets']

- name: Generate database password if not exists
  ansible.builtin.set_fact:
    netbox_db_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
  no_log: true
  when: netbox_db_password is not defined
  tags: ['vault', 'secrets']

- name: Store database credentials in Vault
  block:
    - name: Get existing Vault data if it exists
      ansible.builtin.set_fact:
        existing_vault_data: "{{ vault_check.json.data.data }}"
      when:
        - vault_check.status == 200
        - vault_check.json is defined
        - vault_check.json.data is defined
        - vault_check.json.data.data is defined
        - vault_check.json.data.data | type_debug == 'dict'

    - name: Initialize empty vault data if none exists
      ansible.builtin.set_fact:
        existing_vault_data: {}
      when: existing_vault_data is not defined

    - name: Merge database credentials with existing data
      ansible.builtin.set_fact:
        vault_data_to_save: "{{ existing_vault_data | combine({
            'db_password': netbox_db_password,
            'db_user': netbox_db_user,
            'db_name': netbox_db_name,
            'db_host': 'localhost',
            'db_port': 5432
          }) }}"
      no_log: true

    - name: Store database credentials in Vault
      ansible.builtin.uri:
        url: "{{ vault_addr }}/v1/{{ vault_kv_path }}"
        method: POST
        headers:
          X-Vault-Token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        body_format: json
        body:
          data: "{{ vault_data_to_save }}"
        status_code: [200, 204]
      no_log: true
  rescue:
    - name: Failed to save credentials to Vault
      ansible.builtin.debug:
        msg: "WARNING: Failed to save database credentials to Vault, but continuing with generated password"
  when:
    - vault_check.status == 404
    - vault_check.status == 200 and (
        vault_check.json is not defined or
        vault_check.json.data is not defined or
        vault_check.json.data.data is not defined or
        vault_check.json.data.data | type_debug != 'dict' or
        vault_check.json.data.data.db_password is not defined
      )
  tags: ['vault', 'secrets']

- name: Create NetBox database user
  community.postgresql.postgresql_user:
    name: "{{ netbox_db_user }}"
    password: "{{ netbox_db_password }}"
    state: present
    encrypted: true
  become: true
  become_user: postgres
  no_log: true
  tags: ['database', 'user']

- name: Create NetBox database
  community.postgresql.postgresql_db:
    name: "{{ netbox_db_name }}"
    owner: "{{ netbox_db_user }}"
    encoding: UTF8
    lc_collate: C.UTF-8
    lc_ctype: C.UTF-8
    template: template0
    state: present
  become: true
  become_user: postgres
  tags: ['database']

- name: Grant all privileges on database to NetBox user
  community.postgresql.postgresql_privs:
    database: "{{ netbox_db_name }}"
    state: present
    privs: ALL
    type: database
    role: "{{ netbox_db_user }}"
  become: true
  become_user: postgres
  tags: ['database', 'permissions']

- name: Configure PostgreSQL to allow local connections
  ansible.builtin.lineinfile:
    path: /etc/postgresql/{{ postgres_version }}/main/pg_hba.conf
    regexp: '^local\s+all\s+{{ netbox_db_user }}'
    line: "local {{ netbox_db_name }} {{ netbox_db_user }} md5"
    insertafter: '^# TYPE'
  notify: restart postgresql
  tags: ['configuration']

- name: Reload PostgreSQL configuration
  ansible.builtin.systemd:
    name: postgresql
    state: reloaded
  tags: ['configuration']
